# Core Engine 黑箱内部业务（设计讨论稿）

本文描述 Core Engine **黑箱内部的业务逻辑**与设计要点，与 [apps/core-egnine.md](../apps/core-egnine.md) 的接口定义互补：后者定义对外的输入、核函数与输出，本文说明这些接口背后引擎在做什么、有哪些可讨论的设计取舍。面向产品、引擎与应用侧的设计讨论，**不**涉及具体数据结构与实现细节。

---

## 1. 仿真循环（单步与多步）

### 1.1 单步流程

引擎的核心闭环即**决策 → 转移 → 归因**：

```
State_k → F_Deliberate → Action_k → F_Transition → State_{k+1} → F_Attribution → Delta_k
```

**变量说明**：

| 符号 | 含义 |
|------|------|
| **State_k** | 第 k 步的当前状态（局势快照），含条款、关系/情绪等维度；k=0 为初始状态 |
| **Action_k** | 本步选出的动作（如 ACCEPT、REJECT、EARNOUT、THREATEN），由 F_Deliberate 输出，或由外部干预注入 |
| **State_{k+1}** | 施加 Action_k 后得到的下一状态，由 F_Transition 确定性地计算 |
| **Delta_k** | 本步的状态变化摘要 + 自然语言解释，由 F_Attribution 输出，描述从 State_k 到 State_{k+1} 发生了什么 |

**核函数**：

- **F_Deliberate**：根据当前状态与 Agent 人格，在允许的动作空间中选出一个动作。
- **F_Transition**：根据当前状态与所选动作，确定性地得到下一状态（系统的「物理定律」）。
- **F_Attribution**：比较前后状态，得到发生了哪些变化，并生成自然语言解释。

一轮仿真即反复执行上述单步，直到满足终止条件。**Utterance**（把动作「说」成自然语言）属于应用层扩展，黑箱内部只处理状态与动作，不展开。

### 1.2 终止条件

典型终止类型包括：

- **成交**：某方执行 ACCEPT 等动作，协议达成。
- **破裂**：超轮次、某方 REJECT 且触发阈值、关系/风险等维度越过临界值等。

具体哪些动作或状态组合触发成交/破裂，由**转移层**的因果规则与域参数决定；设计时需明确终止判定逻辑，以便 Trace 与 Outcome 一致。

### 1.3 Trace 与 Outcome

- **Simulation Trace**：完整的决策链，即 `[State_0, Action_0, State_1, Action_1, ...]` 的抽象表述。用于回放、分支推演（L5）、评估（L6）等下游消费。
- **Outcome**：是否成交、破裂原因（若适用），以及若干关键指标（如轮次、最终条款维度等）。不展开具体字段形状，保持概念级。

---

## 2. 决策层（F_Deliberate）

### 2.1 职责

在给定 **State**、**Profile**、**Action Space** 下，为当前轮次的 Agent 选出下一步 **Action**。纯粹的决策层，不修改状态。

### 2.2 输入如何影响决策

- **State**：当前局势（如价格、概率、风险、轮次等抽象维度）决定可选动作的合理性及偏好。例如，价格已接近对方底线时，ACCEPT 的吸引力上升。
- **Profile**：人格参数（如进取度、风险厌恶、对关系/条款的权重等）影响动作选择。Profile 来自 **L3 拟合**或**预设模版**，此处不展开 L3。
- **Action Space**：约束当前步允许的动作集合（如 `ACCEPT`、`REJECT`、`EARNOUT`、`THREATEN`）。可随轮次或状态动态收缩/扩展，由调用方或转移规则决定。

### 2.3 LLM 的角色与设计点

决策层**调用 LLM** 做动作选择。可讨论的设计点包括：

- **Prompt 组织**：如何把 State、Profile、Action Space 编码进 prompt；是否需要少量 Few-shot 或规则约束。
- **上下文压缩**：是否使用 **LastK** 等机制压缩历史（例如最近几步的 State-Action 摘要），在 token 上限与决策质量之间权衡。
- **温度与采样**：确定性推演 vs 适度随机（如蒙特卡洛多 run）；温度、top-p 等如何设置。
- **可选的策略与语气输出**：是否额外输出 `strategy_tags`、`tone_style` 等，供 L6 评估或教学场景使用。

---

## 3. 转移层（F_Transition）

### 3.1 职责

由 `(State, Action)` **确定性地**得到 `Next_State`。这是系统的「物理定律」：同一输入必得同一输出，**不可**由 LLM 改写，保证推演可复现、可解释。

### 3.2 因果规则（概念与示例）

转移规则定义「做了动作 A 后，状态各维度如何变化」。例如（仅作示意，非穷举）：

- **EARNOUT**：价格下调、达成概率上升；可配有步长、上下界等参数。
- **THREATEN**：关系紧张度上升、对方风险感知增强；可能提高破裂概率。
- **ACCEPT**：进入成交终态；**REJECT** 可能直接破裂或抬高紧张度，取决于规则设计。

设计时需明确：每类动作影响哪些状态维度、影响方向与幅度、是否存在耦合（如紧张度升高导致对方更不愿让步）。

### 3.3 状态维度与终止判定

状态至少包含**条款类**（如价格、概率、风险、轮次）与**关系/情绪类**（如紧张度、信任度等），与 [apps](../apps/core-egnine.md) 的 `price, prob, risk, step` 等对应即可，不展开字段级定义。

**终止判定**与转移规则一体：某些 Action（如 ACCEPT）或 State 组合（如超轮次、紧张度超阈值）触发**成交**或**破裂**。需在设计阶段约定清楚，以便 Trace 收束与 Outcome 一致。

### 3.4 域相关参数

不同场景（M&A、劳资纠纷、教学案例等）可使用不同的 **CausalTransition 参数集**：同一动作在不同域中幅度、阈值可不同。引擎支持**可配置**的规则集即可，具体表结构不在本文讨论。

---

## 4. 归因层（F_Attribution）

### 4.1 职责

比较 **State** 与 **Next_State**，得到「发生了什么变化」以及**自然语言解释**。服务于可解释性、复盘报告、教学反馈等下游用途。

### 4.2 Delta 与解释

- **Delta**：哪些维度变化、大致方向与幅度（概念上对应 pipeline 中的 StateDelta）。不采用 patch 等实现级描述，保持概念级。
- **解释生成**：可用**规则模板**（如「价格下降 5%，紧张度上升 0.1」）或 **LLM 生成**（更自然，但可控性与成本不同）。设计时可权衡可读性、稳定性、成本与多语言需求。

---

## 5. 扩展与设计讨论点

### 5.1 外部干预

教师、战略家等可能**注入动作**（如「坚持报价 50」「Inject Shock」），覆盖某步的 F_Deliberate 输出。引擎需支持「**覆盖本步 Action**」的机制，包括：

- **接口**：本轮是否接受外部给定的 Action，若提供则跳过 F_Deliberate。
- **时序**：在步内何时注入、是否影响后续 Action Space 与转移规则。

具体协议可在接口层与编排层细化。

### 5.2 多轮推演与蒙特卡洛

业务中存在「跑 100 次」等**蒙特卡洛**需求。可讨论：

- 多 run 由**引擎内置**（如 `run_n_simulations(n, ...)`）还是**上层多次调用**单次仿真。
- 若内置：初始状态/随机性（如 Profile 采样、动作 tie-break）如何注入；Trace 与 Outcome 的聚合方式（如破裂比例、期望效用）。

### 5.3 无状态与可插拔 LLM

- **无状态**：引擎不保存跨调用状态，一切依赖外部传入的 Context（State、Profile、Action Space、可选的历史摘要）。
- **可插拔 LLM**：决策与归因均可切换模型（如 Llama-3 与 GPT-4）。设计时需考虑切换对**延迟、成本、表现**的影响，以及是否对某些场景固定模型。

---

## 6. 与上下游的衔接（概念级）

### 6.1 上游

**State**、**Profile**、**Action Space** 的来源包括：

- **L0–L3 pipeline**：录音 → 转写 → 事件 → 状态轨迹 → 人格拟合；引擎消费其输出，不关心 L0–L1 的音频与转写细节。
- **教学/战略配置**：预设案例模版、初始状态与 Profile，直接加载后调用引擎。

仅建立概念衔接，不展开 pipeline 各层。

### 6.2 下游

**Trace** 与 **Outcome** 可被：

- **L5 分支推演**：在某一状态注入干预，继续推演得到分支路径；引擎提供单轮/多轮仿真能力。
- **L6 评估与报告**：指标计算、量表评分、复盘报告生成等，消费 Trace 与 Outcome。

同样保持概念级，不涉及 L5/L6 的数据结构定义。
